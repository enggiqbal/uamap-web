{% load compress %}
<!-- code was written by: Md Iqbal Hossain (hossain@email.arizona.edu) -->
<!---see UAMAP_license.txt -->
<!DOCTYPE html>
<html>
<head>
	 <title>uamap: topics network</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="/static/css/bootstrap.css" rel="stylesheet">

    <link href="/static/css/ui-lightness/jquery-ui-1.10.3.custom.min.css" rel="stylesheet">
{% compress js %}
    <script type="text/javascript" src="/static/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery-ui-1.10.3.custom.min.js"></script>





{% if data.submap == 'world' %}<script type="text/javascript" src="/static/js/WorldTopicsNetwork.js"></script><script type="text/javascript" src="/static/js/WorldTopicsNetwork_zoom.js"></script>{% endif %}



{% endcompress %}

    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
 <script type="text/javascript" src="/static/js/d3_star.js"></script>





    <style>




.rotatetext1 {

    color: white;
}
.rotatetext2 {



    color: red;
}


.link { stroke:  #999;}
.dropdown-content2 {   display: none;  position: absolute; background-color: #f9f9f9; min-width: 160px; overflow: auto; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); top:25%; left:50%; position: fixed; padding:10px;text-align:left;}


.infodiv-content2 {   display: none;  position: absolute; background-color: #f9f9f9; min-width: 160px; overflow: auto; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); top:10%; left:15%; position: fixed; padding:10px;text-align:left;}



	body.waiting * {   cursor: progress;}
	.wait, .wait * { cursor: wait; }
	html,body {height: 100%; margin: 0; padding: 0;}
	#map {height: 100%;}
	img {opacity: 0.5;filter: alpha(opacity=50);}
	img:hover {opacity: 1.0; filter: alpha(opacity=100);}







.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
top:25%;
left:70%;
position: fixed

}

.dropdown-content a {
    color: black;
    padding: 8px 8px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #f1f1f1}

.show {display:block;}










#load{
    width:100%;
    height:100%;
    position:fixed;
    z-index:9999;
    background:url("/static/icon/loading.gif") no-repeat center center rgba(0,0,0,0.25)
}





	</style>
</head>

<body  >
 <div id="load"></div>


	<div id="map" style="clear: both;"></div>





<div id="popupdiv1" class="dropdown-content2">
	<div id="popupdiv2" style="background-color:#B5B2B2">
		<img src="/static/icon/close.png"  width=32px  onclick="closethis('popupdiv1')">
	</div>

	<div id="popupdiv">
<!--
	Fund Agency <select id="agency_select">
<option value='ACF'>Administration for Children and Families (ACF)</option>
<option value='AHRQ'>Agency for Healthcare Research and Quality(AHRQ)</option>
<option value='ALLCDC'>ALLCDC</option>
<option value='ARS'>Agriculture Research Service(ARS)</option>
<option value='CCCRP'>Combat Care Casualty Research Program(CCCRP)</option>
<option value='CDMRP'>Congressionally Directed Medical Research Programs(CDMRP)</option>
<option value='CNRM'>Center for Neuroscience and Regenerative Medicine(CNRM)</option>
<option value='DVBIC'>Defense and Veterans Brain Injury Center(DVBIC)</option>
<option value='EPA'>Environmental Protection Agency(EPA)</option>
<option value='FDA'>Food and Drug Administration(FDA)</option>
<option value='FS'>Forest Service(FS)</option>
<option value='IES'>Institute of Education Sciences(IES)</option>
<option value='NASA'>National Aeronautics and Space Administration(NASA)</option>
<option value='NIDILRR'>National Institute on Disability, Independent Living, and Rehabilitation Research(NIDILRR)</option>
<option value='NIFA'>National Institute of Food and Agriculture(NIFA)</option>
<option value='NIH'>National Institutes of Health(NIH)</option>
<option value='NSF' selected >National Science Foundation (NSF)</option>
<option value='VA'>U.S. Department of Veterans Affairs (VA)</option>
</select>
-->
Fund Department <select id="agency_select">

<option value='USDA'>United States Department of Agriculture (USDA)</option>
<option value='HHS'>Department of Health and Human Services(HHS)</option>

<option value='EPA'>Environmental Protection Agency(EPA)</option>
<option value='DOD'>Department of Defense(DOD)</option>
<option value='NSF'>National Science Foundation(NSF)</option>
<option value='NASA'>National Aeronautics and Space Administration (NASA)</option>
<option value='VA'>U.S. Department of Veterans Affairs (VA)</option>
<option value='ED'>ED</option>
</select>
<br>
University/Organization Name: <input type =text name=fundOranization onkeyup=getfunOranizationList(this.value)>
<div id="fundOranizationdiv">

</div>

	</div>
</div>





<div id="graphdiv1" class="dropdown-content2">
<div id="graphdiv2" style="background-color:#B5B2B2">
<img src="/static/icon/close.png"  width=32px  onclick="closethis('graphdiv1')">
</div>

<div id="graphdiv"    >
</div>
</div>



<div id="infodiv1" class="infodiv-content2">
<div id="infodiv2" style="background-color:#B5B2B2">
<img src="/static/icon/close.png"  width=32px  onclick="closethis('infodiv1')">
</div>

<div id="infodiv" >

<fieldset>
<legend>HPU settings and Legend</legend>

<br> HPU Threshold <input type="range" id="hpudiff" onchange="updatelegend()"  min="1" max="20" value="10" step="1">
 HPU Circle amplifier  <input type="range" id="hpucircle"  onchange="updatelegend()"  min="1" max="13" value="1.5" step="1">

<br>


HPU per thousand:<br>
<svg height="150"   width="500" xmlns="http://www.w3.org/2000/svg" version="1.1">
 <circle cx="100" fill-opacity="0.6" id ="circlem3" cy="50" r="40" stroke="#800080" stroke-width="0" fill="#800080" />
  <circle cx="180"   fill-opacity="0.6" id ="circlem2"  cy="50" r="25" stroke="#800080" stroke-width="0" fill="#800080" />
   <circle cx="230"  fill-opacity="0.6"  id ="circlem1"  cy="50" r="15" stroke="#800080" stroke-width="0" fill="#800080" />

<circle cx="260"  fill-opacity="0.6" id ="circle0"  cy="50" r="5" stroke="black" stroke-width="1" fill="white" />

<circle cx="290"  fill-opacity="0.6" id ="circlep1" cy="50" r="15" stroke="green" stroke-width="0" fill="green" />
  <circle cx="340"  fill-opacity="0.6" id ="circlep2"  cy="50" r="25" stroke="green" stroke-width="0" fill="green" />
   <circle cx="420"  fill-opacity="0.6" id ="circlep3"  cy="50" r="40" stroke="green" stroke-width="0" fill="green" />


 <text id="textm3" x="90" y="110" fill="#800080">1.3</text>
 <text id="textm2" x="170" y="110" fill="#800080">2.3</text>
 <text id="textm1" x="220" y="110" fill="#800080">3.3</text>
 <text  id="text0"  x="260" y="110" fill="black">0</text>
 <text  id="textp1" x="280" y="110" fill="green">2.4</text>
 <text  id="textp2" x="330" y="110" fill="green">2.4</text>
 <text id="textp3"  x="410" y="110" fill="green">2.4</text>

</svg>
<br>

<div id=threshold></div>
</fieldset>

<fieldset>
<legend>citation settings and Legend</legend>
Show citations as<input type=radio id=citationascircleHeatmap name="radcitationascircleHeatmap" checked onclick="updatelegend()" value=1>  heatmap <input type=radio  name="radcitationascircleHeatmap" id=citationascirclecircles onclick="updatelegend()"  value=0> circles

<br>Citation intensity <input type="range" id="citationcircle"  onchange="updatelegend()" min="50" max="100" value="100" step="10">

<br>


<svg height="150"   width="500" xmlns="http://www.w3.org/2000/svg" version="1.1">

	<circle cx="190"  fill-opacity="0.6" id ="ccirclep1" cy="50" r="15" stroke="yellow" stroke-width="0" fill="yellow" />
  <circle cx="240"  fill-opacity="0.6" id ="ccirclep2"  cy="50" r="25" stroke="yellow" stroke-width="0" fill="yellow" />
   <circle cx="320"  fill-opacity="0.6" id ="ccirclep3"  cy="50" r="40" stroke="yellow" stroke-width="0" fill="yellow" />

 <text x="10" y="110" fill="green">Aggregation:</text>
 <text  x="180" y="110" fill="green">1.5M</text>
 <text   x="230" y="110" fill="green">2.5M</text>
 <text   x="310" y="110" fill="green">4.0M</text>

 <text x="10" y="140" fill="green">Single Univ:</text>
 <text id=sutext1  x="180" y="140" fill="green">15K</text>
 <text id=sutext2  x="230" y="140" fill="green">25K</text>
 <text  id=sutext3  x="310" y="140" fill="green">40K</text>

</svg>


</fieldset>


</div>
</div>


<script>






	var map, heatmap;
//	var polylinepoints = Array();
	var topicsNode = Array();
	var nodelatlan = Array();
	var heatmapcitation = Array();
//	var edges = Array();
	var edgesdata = Array();
	var label = Array();
	var edgespoly = Array();
	var polygon = Array();
	var citationheatmapdata = Array();
	var fundheatmapdata=Array();
	var marker = Array();
	var infowindow= Array();
	var collegeIndex = Array();
	var showfundheatmapflag=0;
	var currentnetwork=0;
 	var N;
	var E;
	var fontsize=Array();
var HPU_Difference=1;
var HPU_Circle_amplifier=1.5;
var citation_intensity=100;
var acitation_factor = 100000;
var  ucitation_factor = 5000;
var showCitationAsCircle=false;

//	var strength_weakness_color=['#7fbf7b','#af8dc3'];//['#4dac26', '#f1b6da']//
//	var  heatmapgradient=['white','#fee0d2','#fdae6b','#de2d26']

	var strength_weakness_color=['green', '#800080']//['#7fbf7b','#af8dc3'];
	var  heatmapgradient=['white','	#800000', 'yellow']

//	var strength_weakness_color=['green', '#800080']//['#7fbf7b','#af8dc3'];
//	var  heatmapgradient=['white','	#800000', 'yellow']
	var citationnormalization=0;
	function CoordMapType(tileSize) {
		this.tileSize = tileSize;
	}

      CoordMapType.prototype.maxZoom = 10;
      CoordMapType.prototype.name = 'uamap';
      CoordMapType.prototype.alt = 'The University of Arizona : Knowledge Map';
      CoordMapType.prototype.getTile = function(coord, zoom, ownerDocument) {
        var div = ownerDocument.createElement('div');
        div.innerHTML = '';
        div.style.width = this.tileSize.width + 'px';
        div.style.height = this.tileSize.height + 'px';
        div.style.fontSize = '10';
        div.style.borderStyle = 'none';
        div.style.borderWidth = '1px';
        div.style.borderColor = '#ffffff';
        div.style.backgroundColor = '#ffffff';
        return div;
      };




function initMap() {
	cursorwait();
	map = new google.maps.Map(document.getElementById('map'), {
	  zoom: 5,
	  center: {lat: 29.479,lng: 42.554 },
	  streetViewControl: false,
	  mapTypeId: 'coordinate',
	  mapTypeControlOptions: {mapTypeIds: ['coordinate']}	});

	map.addListener('maptypeid_changed', function() {
		var showStreetViewControl = map.getMapTypeId() !== 'coordinate';map.setOptions({streetViewControl: showStreetViewControl,  animatedZoom: false});		});
	map.mapTypes.set('coordinate', new CoordMapType(new google.maps.Size(256, 256)));
	//loading data from data.js
	{% autoescape off %}

	// data.data  }}
	{% endautoescape %}

	getReadyLabel();


	//WorldTopicsNetwork()
	{% if data.submap == 'ua' %}DrawUAdMap();{% endif %}
	{% if data.submap == 'world' %}WorldTopicsNetwork();{% endif %}


	// adding controls in TOP_CENTER and RIGHT_CENTER positions

	var centerControlDiv = document.createElement('div');
	var centerControl = new CenterControl(centerControlDiv, map,1,0);
	centerControlDiv.index = 1;
	var centerControlDiv2 = document.createElement('div');
	var centerControl2 = new CenterControl(centerControlDiv2, map,2,0);
	centerControlDiv2.index = 2;
	map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);
	map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(centerControlDiv2);


	centerControlDiv2 = document.createElement('div');
	var centerControl2 = new CenterControl(centerControlDiv2, map,4,0);
	centerControlDiv2.index = 4;
	map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(centerControlDiv2);


	//adding map event function
//	google.maps.event.addListener(map, 'zoom_changed', function() { zoomfunction();});
//	google.maps.event.addListener(map,'dragend',function() { zoomfunction(); });
	google.maps.event.addListener(map,'idle',function() { zoomfunction(); });

	{% if data.Clustering == '' %}//toggleClustering();{% endif %}
	{% if data.Fund == 'Yes' %}showfundheatmap();{% endif %}
	{% if data.Citation == 'Yes' %}citationheatmap();{% endif %}
	{% if data.Connections == 'Yes' %}toggleEdge();{% endif %}
	cursordefault();


}






function getReadyLabel() {
	Label.prototype = new google.maps.OverlayView;
	// Implement onAdd
	Label.prototype.onAdd = function() {
		var pane = this.getPanes().overlayMouseTarget;
		pane.appendChild(this.div_);
		// Ensures the label is redrawn if the text or position is changed.
		var me = this;
		this.listeners_ = [
			google.maps.event.addListener(this, 'position_changed', function() { me.draw();})]
		//	google.maps.event.addListener(this, 'text_changed', function() { me.draw();	}),
		//	google.maps.event.addListener(this, 'click', function() {me.click(); })	];
		};


	// Implement draw
	Label.prototype.draw = function() {

		var projection = this.getProjection();
		var position = projection.fromLatLngToDivPixel(this.get('position'));
		var div = this.div_;


		div.style.left = (position.x )    + 'px';
		div.style.top = (position.y  ) + 'px';
		div.style.display = 'block';

		};
}









     function Label(opt_options) {
        this.setValues(opt_options);
		var SpanIndex=opt_options.nodenumber;
     var   span = this.span_ = document.createElement('span');
	span.id="s"+ SpanIndex ;
        span.className = 'vtitle';
		size=getInitialFontSize(currentnetwork,opt_options.weight["w"] )
         span.style.cssText = 'position: relative; left: -50%; top: -8px; ' +          'white-space: nowrap; border: 0px solid blue;  font-size: ' + size + '%; ' +       'padding: 2px; background-color: transparent';
 //  span.style.cssText = '  position: relative; left: -50%;  top: -8px; font-size: ' + size + '%; ' ;
        this.span_.innerHTML = opt_options.data;
         var div = this.div_ = document.createElement('div');
		div.id="n"+ SpanIndex ;
        div.appendChild(span);
	//	div.innerHTML = opt_options.data;
        div.style.cssText = 'position: absolute; display: none';
	//	div.style.cssText = '  font-size: ' + size + '%; ' ;

	google.maps.event.addDomListener(span, 'mouseover', function() { this.style.color = '#ff0000'; });
	google.maps.event.addDomListener(span, 'mouseout', function() { this.style.color = '#000000'; });

			google.maps.event.addDomListener(span, 'click', function() {
			infowindow[SpanIndex].open(map,marker[SpanIndex])
			showmyedges(SpanIndex)

			  });
      }








function getInitialInfoWindow()
{

	var infowindow  =  new google.maps.InfoWindow({	content: "content will come" });
	var contentdiv= document.createElement('div')
	var   centerControlDivData = new CenterControl(contentdiv, map,3,0);
	contentdiv.index = 3;
	if (map.controls[google.maps.ControlPosition.RIGHT_TOP].length !=0) map.controls[google.maps.ControlPosition.RIGHT_TOP].pop()
	map.controls[google.maps.ControlPosition.RIGHT_TOP].push(contentdiv);
}

function cursorwait() {
    document.body.className = 'wait';
}

function cursordefault() {
    document.body.className = '';
}


function CenterControl(controlDiv, map,c,E) {
	// Set CSS for the control border.
	var controlUI = document.createElement('div');
	controlUI.style.backgroundColor = '#fff';
	controlUI.style.border = '2px solid #fff';
	controlUI.style.borderRadius = '3px';
	controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
	controlUI.style.cursor = 'pointer';
	controlUI.style.marginBottom = '22px';
	controlUI.style.textAlign = 'center';
	controlDiv.appendChild(controlUI);
	// Set CSS for the control interior.
	var controlText = document.createElement('div');
	controlText.style.color = 'rgb(25,25,25)';
	controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
	controlText.style.fontSize = '10px';
	controlText.style.lineHeight = '20px';
	controlText.style.paddingLeft = '5px';
	controlText.style.paddingRight = '5px';
//<img align="middle" width="32px" height="32px" src="/static/icon/images/edges.png" id="toggleEdgeIMG" onclick="showedgesinCurrentLevel()" title="Current Level Connections"><br><br> Current Edges

	if (c==1) //Top Center controls
	controlText.innerHTML = '  <input style="margin-top: 15px" type=text  class="form-control" placeholder="Topics Search" title="Author Search"  onkeydown="if (event.keyCode == 13) { searchname(this.value) }" > <span style="margin-top: 15px; font-size:150% "> Change Basemap</span>  <select style="margin-top: 15px" onchange=changebasemap(this.value) name=basemap placeholder="Change Basemap" ><option value=1 selected>All Universities  </option> <option value=2 >US Universities</option></select>';
//<option value=3>European Universities</option><option value=4>Others Universities</option><option value=5>Top 500 Universities</option></select>';
//<img align="middle" width="32px" height="32px" src="/static/icon/uofa.svg" class="dropbtn" onclick="showuofa()" title="UofA">
	if (c==2) //Right Center controls
	controlText.innerHTML = '<br><b>Overlays</b> <br>'+getUnivesityText()+'<br><img align="middle" width="32px" height="32px" src="/static/icon/images/clustering.png"  style="opacity:1"  id="toggleClusteringIMG" onclick="toggleClustering()" title="Clustering"><br>Clustering <br><img align="middle" width="32px" height="32px" src="/static/icon/images/edges.png" id="toggleEdgeIMG" onclick="showedgesinCurrentLevel()" title="Current Level Connections"><br>Current Edges<br><img align="middle" width="16px" height="16px"  style="height:16px" src="/static/icon/e1.svg" onclick="edgeOpacity(-0.02)" title="Edge Opacity -"> <img style="height:16px" align="middle" width="16px" height="16px" src="/static/icon/e2.svg" onclick="edgeOpacity(0.02)" title="Edge Opacity+"> <br> <img align="middle" width="32px" height="32px" src="/static/icon/images/reset.png"  id="" onclick="reset()" title="Reset"><br>Reset ';



	if (c==4) //Right Center controls
	controlText.innerHTML = '<img align="middle" width="32px" height="32px" src="/static/icon/images/search.png"  style="opacity:1"     title="search"><br><img align="middle" width="32px" height="32px" src="/static/icon/images/info.png" onclick="showinfo()" style="opacity:1"     title="info">';





	if (c==3){//Top right controls
	controlText.style.textAlign="left";
	controlText.style.fontSize = '10px';
	if (currentnetwork==1) {info="<b> World Knolwledge Map </b>"; }
	if (currentnetwork==2) {info="<b> UofA Knolwledge Map </b>";  }
 	controlText.innerHTML ="<div id=top10>" + info  +TopTenResearchTopics()+"</div>" ;
	}

	controlUI.appendChild(controlText);

}

var basemapdata;

function getfunOranizationList(v)
{
var agency=document.getElementById("agency_select").value
 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {
 		document.getElementById("fundOranizationdiv").innerHTML=this.responseText
//	   console.log(this.responseText);

      return "";
    }
  };
  xhttp.open("GET", "/getfunOranizationList/" + v + "/" +  agency , true);
  xhttp.send();

return "Loading";

}

function changebasemap(region)
{




 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {
	dept=""
	   code=this.responseText;
	  	eval(code);
		basemapdata=topicscount;
  		 basemapprocess(topicscount, peoplecount,region);

      return "";
    }
  };
  xhttp.open("GET", "/universityregion/" + region , true);
  xhttp.send();

return "Loading";
}

function  basemapprocess(topicscount, peoplecount,region)
{
currentnetwork=region
//console.log(topicscount)
changenodesize(topicscount)
}



function compare(a,b) {
  if (a.w < b.w)
    return 1;
  if (a.w > b.w)
    return -1;
  return 0;
}

function TopTenResearchTopics()
{
var x = Object.create(topicsNode);
var txt=""
x=x.sort(compare)
for (var i=0; i<10; i++)
txt=txt+"<br>" + x[i].n + ": "+  x[i].w
return txt
}

 function getUnivesityText(){
//txt ='<div class="dropdown"><img align="middle" width="32px" height="32px" src="/static/icon/university.svg" class="dropbtn" onclick="dropdownFunction(\'HPU Overlay\')" title="university"><br> <img align="middle" width="32px" height="32px" src="/static/icon/citation.svg" class="dropbtn" onclick="dropdownFunction(\'Citation Overlay\')" title="university"> <br> <img align="middle" width="32px" height="32px" src="/static/icon/dept.svg" class="dropbtn" onclick="dropdownFunction(\'Department Overlay\')" title="department"> <br> <img align="middle" width="32px" height="32px" src="/static/icon/doc.svg" class="dropbtn" onclick="dropdownFunction(\'Document Overlay\')" title="document">  <div id="CollegeDropdown" class="dropdown-content"><br><div id=overlaytype >HPU</div><br><div id="userinputdiv"></div><div id="utextid"></div> '
txt ='<div class="dropdown">'+
'<img align="middle" width="32px" height="32px" src="/static/icon/images/hpu.png" class="dropbtn" onclick="dropdownFunction(\'HPU Overlay\')" title="university HPU"><br>HPU<br>'+
'<img align="middle" width="32px" height="32px" src="/static/icon/images/cite.png" class="dropbtn" onclick="dropdownFunction(\'Citation Overlay\')" title="university citation"><br>Citation <br>'+
'<img align="middle" width="32px" height="32px" src="/static/icon/images/agg.png" class="dropbtn" onclick="aggwindows()" title="Aggregated Overlay"><br>Aggregated <br> '+
'<img align="middle" width="32px" height="32px" src="/static/icon/images/dept.png" class="dropbtn" onclick="dropdownFunction(\'Department Overlay\')" title="department"> <br>Department <br>'+
'<img align="middle" width="32px" height="32px" src="/static/icon/money.png" class="dropbtn" onclick="fundoptions()" title="Fund"><br>Fund'+  '<div id="CollegeDropdown" class="dropdown-content"><br><div id=overlaytype >HPU</div><br><div id="userinputdiv"></div><div id="utextid"></div> '

  txt = txt + '<a href="#" onclick=collegeHeatMap(\'all\')>Close</a>'



 txt = txt +  '</div></div>'
return txt
}


function fundoptions()
{var x=document.getElementById("popupdiv1")
x.style.display="block";
Windowspreparation3(document.getElementById('popupdiv1'), document.getElementById('popupdiv2'))
}

function searchDepartment(v)
{
v=   document.getElementById("deptsearch").value;
 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {
	dept=""
	   code=this.responseText;
//	console.log(code);
	eval(code);
  		 showDocumentOverlay(dept,123); var data=dept;

      return this.responseText;
    }
  };
  xhttp.open("GET", "/searchdept/" + v , true);
  xhttp.send();

return "Loading";

}





function searchDocument(v)
{
v=   document.getElementById("docsearch").value;
 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {
	dept=""
	   code=this.responseText;
//	console.log(code);
	eval(code);
    //  document.getElementById("utextid").innerHTML=this.responseText
		 showDocumentOverlay(doc,123); var data=doc;

      return this.responseText;
    }
  };
  xhttp.open("GET", "/docresearchtopics/" + v , true);
  xhttp.send();

return "Loading";

}




function searchUniversity(v)
{
 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {

      document.getElementById("utextid").innerHTML=this.responseText

      return this.responseText;
    }
  };
  xhttp.open("GET", "/searchuniversity/" + v , true);
  xhttp.send();

return "Loading";

}




function collegeHeatMap(v) {
	if (v == 'all') {
	  for (i = 0; i < N; i++) {
		marker[i].setVisible(false)
	  }
	}
	icon = {
	  path: google.maps.SymbolPath.CIRCLE,
	  scale: 5,
	  strokeColor: 'red',
	  fillColor: 'red',
	  fillOpacity: 0.5,
	  strokeWeight: 0
	}
	for (i = 0; i < N; i++) {
	  if (topicsNode[i]['c'] == v) {
		marker[i].setMap(map);
		marker[i].setIcon(icon)
		marker[i].setVisible(true) //	label[i].setMap(map);
	  } else {
		marker[i].setVisible(false) //	label[i].setMap(null);
	  }
	}
}


uofadot=0
function showuofaX() {
if(uofadot==1)
{	  for (i = 0; i < N; i++) {
		marker[i].setVisible(false)
	  }
uofadot=0
return 0;
}
uofadot=1

	icon = {
	  path: google.maps.SymbolPath.CIRCLE,
	  scale: 5,
	  strokeColor: 'red',
	  fillColor: 'red',
	  fillOpacity: 0.5,
	  strokeWeight: 0
	}
	for (i = 0; i < N; i++) {
	  if (topicsNode[i]['u']>0) {
		marker[i].setMap(map);
		marker[i].setIcon(icon)
		marker[i].setVisible(true) //	label[i].setMap(map);
	  } else {
		marker[i].setVisible(false) //	label[i].setMap(null);
	  }
	}
}



















uofadot=0
function showuofa() {

if(uofadot==1)
{	  for (i = 0; i < N; i++) {
		marker[i].setVisible(false)
	  }
uofadot=0
return 0;
}
uofadot=1


	for (i = 0; i < N; i++) {

	var u= topicsNode[i]['u'] * 1000/1127
	var w= topicsNode[i]['w'] * 1000/433781
if(u>w)
color='green'
else
color='red'

	icon = {
	  path: google.maps.SymbolPath.CIRCLE,
	  scale: Math.abs(u-w) * 6,
	  strokeColor: color,
	  fillColor: color,
	  fillOpacity: 0.5,
	  strokeWeight: 0
	}




	  if ( Math.abs(u-w)>1) {
		marker[i].setMap(map);
		marker[i].setIcon(icon)
		marker[i].setVisible(true) //	label[i].setMap(map);
	  } else {
		marker[i].setVisible(false) //	label[i].setMap(null);
	  }
	}
}














function showMarkers() {
	var bounds = map.getBounds();
	for (i = 0; i < N; i++) {
	  if (document.getElementById('uaCollege').value == 'all')
		cond = 1
	  else
	  if (document.getElementById('uaCollege').value == topicsNode[i]['c'])
		cond = 1
	  else
		cond = 0
	  if (cond && bounds.contains(marker[i].getPosition())) {
		marker[i].setMap(map)
		label[i].setMap(map)
	  } else {
		marker[i].setMap(null)
		label[i].setMap(null)
	  }
	}
}
/*
function DrawProposalMap() {
	currentnetwork=1;
	polygonpoints = graph1polygonpoints;
	topicsNode = graph1nodeUAuser;
	nodelatlan = graph1nodelatlan;
	heatmapcitation = graph1heatmapcitation;
	edgesdata = graph1edgesdata;
	collegeIndex = graph1collegeIndex
	map.setCenter({lat: 21,lng: 21 })
	CommonFunctionforAllMap(graph1polygonpoints,graph1fillColor,graph1edges)

}
*/
function WorldTopicsNetwork() {
	currentnetwork=1;
//	polylinepoints = graph2polylinepoints;
//	collegeIndex = WorldTopicsNetworkcollegeIndex
	topicsNode = WorldTopicsNetworknodeUAuser;
	nodelatlan = WorldTopicsNetworknodelatlan;
//	heatmapcitation = WorldTopicsNetworkheatmapcitation;
	edgesdata = WorldTopicsNetworkedgesdata;

 	CommonFunctionforAllMap(WorldTopicsNetworkpolygonpoints,WorldTopicsNetworkfillColor,WorldTopicsNetworkedges)

}
/*
function DrawUAdMap() {
	currentnetwork=2;
//	polylinepoints = graphpolylinepoints;
	topicsNode = UATopicsNetworknodeUAuser;
	nodelatlan = UATopicsNetworknodelatlan;
//	heatmapcitation = UATopicsNetworkheatmapcitation;
	edgesdata = UATopicsNetworkedgesdata;
//	collegeIndex = graphcollegeIndex
	CommonFunctionforAllMap(UATopicsNetworkpolygonpoints,UATopicsNetworkfillColor,UATopicsNetworkedges)
}
*/

function CommonFunctionforAllMap(graphpolygonpoints,graphfillColor,graphedges)
{
	E=edgesdata.length;
	N=topicsNode.length;
	drawcluster(graphpolygonpoints,graphfillColor);
	drawingnodes( )
	drawingedges(graphedges);
	GetReadyCititaionHeatmap();
	showfundheatmapflag=0;
	getInitialInfoWindow();
	getReadyFontSizeforAll(currentnetwork,'')
	google.maps.event.addListenerOnce(map, 'idle', function(){zoomfunction()});

}





      function GetReadyCititaionHeatmap() {
	toggleICON("drawheatmapIMG")
        citationheatmapdata = []
        for (i = 0; i < heatmapcitation.length; i++) {
          citationheatmapdata[i] = {
            location: new google.maps.LatLng(nodelatlan[heatmapcitation[i].i].lat, nodelatlan[heatmapcitation[i].i].lng),
            weight: heatmapcitation[i].w
          }
        }
        heatmap = new google.maps.visualization.HeatmapLayer({
          data: citationheatmapdata,
          //		map: map,
          order: 100,
          radius: 100
        });
      }

function boundarychanged()
{

zoomfunction();
}

function calculatingNodeVisibility()
{
var vertextInsideofBoundary=Array()
nodesizesetting=document.getElementById("changenodesizedropdown")
zlevel=map.zoom
for(var i=0; i<N; i++)
		{
		var element=document.getElementById("s"+i)
 	 vertextInsideofBoundary[i]={index:i, font:topicsNode[i].w, box:element.getBoundingClientRect()};
 	}

var v=vertextInsideofBoundary.sort(cmp);
var nodevisibile=Array()
var alreadydrawn=Array()
NN=v.length
j=0;
for (var i=0; i<NN; i++)
{

if(is_small_for_zoom_level(zlevel, topicsNode[v[i].index]  ))
{ nodevisibile[v[i].index]= "0";
document.getElementById("n"+v[i].index).style.visibility = "hidden"
 continue;}



	if(isoverlapped(alreadydrawn,v[i].box)){
	 nodevisibile[v[i].index]= "0";
document.getElementById("n"+v[i].index).style.visibility = "hidden"
}
	else{
	document.getElementById("n"+v[i].index).style.visibility = "visible"
		alreadydrawn[j]=v[i].box;
		j=j+1;
		nodevisibile[v[i].index]="1" }
}
str=""
for (var i=0; i<NN; i++)
{
str=str+nodevisibile[i]
}
//console.log("zoomdata[\"degree\"]["+ map.zoom +"]=\"" + str + "\";")
console.log("zoomdata["+currentnetwork+"]["+ map.zoom +"]=\"" + str + "\";")
//console.log(nodevisibile.length)
}


function getUniversitydata(gsuid, name)
{


 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {
	  code=this.responseText;
	eval(code)     ;

	if(document.getElementById("overlaytype").innerHTML.split(" ")[0]=="HPU")
		{showUniversity(HPU,peoplecount); var data=HPU; topTenforSelectedUniversity(data,name, peoplecount);}
	else { ccount=showCitationOverlay(citation,peoplecount); var data=citation; topTenforSelectedUniversity(data,name, ccount); }




    }
  };
  xhttp.open("GET", "/getuinfo/" + gsuid + "/" + document.getElementById("overlaytype").innerHTML.split(" ")[0] , true);
  xhttp.send();

return "Loading";



}






function getFederalFund(university, sponsor,yearfrom,yearto)
{
sponsor=document.getElementById("agency_select").value

 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {
	  code=this.responseText;
	eval(code)     ;
console.log(code)
	federalFundOverlay(federaltopics)

    }
  };
  xhttp.open("GET", "/getFederalFund/" + university + "/" + sponsor + "/"+  yearfrom+"/"+ yearto , true);
  xhttp.send();

return "Loading";



}


function federalFundOverlay(federaltopics)
{


	for (var i = 0; i < N; i++) {


if (topicsNode[i]['n'] in federaltopics){
 		c=federaltopics[topicsNode[i]['n']]/5
		color= strength_weakness_color[0] //'green'

		icon = {
		  path: google.maps.SymbolPath.CIRCLE,
		  scale: c,
		  strokeColor: color,
		  fillColor: color,
		  fillOpacity: 0.6,
		  strokeWeight: 0
		}

 		marker[i].setMap(map);
		marker[i].setIcon(icon)
		marker[i].setVisible(true)
		}
else
	marker[i].setVisible(false)

	}



}


function	topTenforSelectedUniversity(d,name, peoplecount)
{
var i=0;
var t=""
for (b in d) {
    t = t+ "<br>" + b + " : " + (""+ d[b]).split(";")[0];

if (i==9) { break;
}

i=i+1;

}


document.getElementById("top10").innerHTML= "<b>"+name+" ("+ document.getElementById("overlaytype").innerHTML.split(" ")[0]+": "+peoplecount+")</b>" + t;
return 1
}

function showDepartmentOverlay(citation,peoplecount) {
//alert("working", citation[0]);

       var citationheatmapdata = []
var j=0;
        for (var i = 0; i < N; i++) {
	var w= isNaN(citation[topicsNode[i]['n']] ) ? 0 : citation[topicsNode[i]['n']] ;
	if(w>0){
          citationheatmapdata[j] = {   location: new google.maps.LatLng(nodelatlan[i].lat, nodelatlan[i].lng),            weight: w          }
			j=j+1;
			}
        }
		heatmap.setMap(null);
        heatmap = new google.maps.visualization.HeatmapLayer({
          data: citationheatmapdata,
          map: map,
          order: 100,
          radius: 100,
		gradient:heatmapgradient
        });
//heatmap.set('gradient',['white','blue']);

}


function showDocumentOverlay(rtopics,peoplecount) {
//alert("working", citation[0]);

       var citationheatmapdata = []
var j=0;
        for (var i = 0; i < N; i++) {
	var w= isNaN(rtopics[topicsNode[i]['n']] ) ? 0 :  rtopics[topicsNode[i]['n']] ;
	if(w>0){
          citationheatmapdata[j] = {   location: new google.maps.LatLng(nodelatlan[i].lat, nodelatlan[i].lng),            weight: w          }
			j=j+1;
			}
        }
//console.log(citationheatmapdata);

heatmap.setMap(null);
        heatmap = new google.maps.visualization.HeatmapLayer({
          data: citationheatmapdata,
          map: map,
          order: 100,
          radius: 100,
		gradient:heatmapgradient
        });


}

function showCitationWithCircle(citation,peoplecount, agg) {
if(agg)
var factor= acitation_factor ;
else
var factor= ucitation_factor ;




citationThresold=5;
 var w=10;
var color='yellow';
	for (var i = 0; i < N; i++) {
if ( topicsNode[i]['n'] in citation ==false)
continue ;

w=parseInt(citation[topicsNode[i]['n']].split(";")[0] ) / factor;
 	icon = {
	  path: google.maps.SymbolPath.CIRCLE,
	  scale: w ,
	  strokeColor: color,
	  fillColor: color,
	  fillOpacity: 0.6,
	  strokeWeight: 0
	}

	  if ( w>citationThresold) {
 		marker[i].setMap(map);
		marker[i].setIcon(icon)
		marker[i].setVisible(true) //	label[i].setMap(map);
	  } else {
		marker[i].setVisible(false) //	label[i].setMap(null);
	  }
	}
}





function showCitationOverlay(citation,peoplecount, agg=false) {
hideClustering();
if(showCitationAsCircle){
showCitationWithCircle(citation,peoplecount,agg);
return 0;
}
//alert("working", citation[0]);
var ccount=0;
       var citationheatmapdata = []
var j=0;
        for (var i = 0; i < N; i++) {

//	var w= isNaN(citation[topicsNode[i]['n']] * 1000/peoplecount) ? 0 : citation[topicsNode[i]['n']] * 1000/peoplecount;
//console.log(citation[topicsNode[i]['n']] * 100);
if ( topicsNode[i]['n'] in citation ==false)
continue ;

//not normalization
w=citation[topicsNode[i]['n']].split(";")[0]  ;
ccount=parseInt(w)+ccount;

//normalization
if(citationnormalization)
w=parseInt(w) * parseFloat(citation[topicsNode[i]['n']].split(";")[1])   ;


	if(w!=0){
          citationheatmapdata[j] = {            location: new google.maps.LatLng(nodelatlan[i].lat, nodelatlan[i].lng),            weight: w          }
			j=j+1;
			}




        }



heatmap.setMap(null);
        heatmap = new google.maps.visualization.HeatmapLayer({
          data: citationheatmapdata,
          map: map,
          order: 100,
          radius: citation_intensity,
	gradient:heatmapgradient,//['white','blue']
        });

return ccount;
}



function showUniversity(d,pepoplecount) {

reset()


var strength_topics_list=[]
var weak_topics_list=[]
//433781
 var worldpeople=375602;
var uspeople=145521;
	for (var i = 0; i < N; i++) {


if(currentnetwork==1)
var w= topicsNode[i]['w'] * 1000/worldpeople;
else
var w= topicscount[topicsNode[i]["n"]] * 1000/uspeople;
var u= isNaN(d[topicsNode[i]['n']] * 1000/pepoplecount) ? 0 : d[topicsNode[i]['n']] * 1000/pepoplecount
var diff=	Math.abs(u-w) * Math.log(w)

if(u>w){
strength_topics_list.push([i,diff])
color= strength_weakness_color[0] //'green'
}
else{
color=strength_weakness_color[1] //'red'
weak_topics_list.push([i,diff])
}

	icon = {
	  path: google.maps.SymbolPath.CIRCLE,
	  scale: diff * HPU_Circle_amplifier,
	  strokeColor: color,
	  fillColor: color,
	  fillOpacity: 0.6,
	  strokeWeight: 0
	}

	  if ( Math.abs(u-w)>HPU_Difference) {
 		marker[i].setMap(map);
		marker[i].setIcon(icon)
		marker[i].setVisible(true) //	label[i].setMap(map);
	  } else {
		marker[i].setVisible(false) //	label[i].setMap(null);
	  }
	}


strength_topics_list.sort(function(a, b) {    return b[1]-a[1] ;});
weak_topics_list.sort(function(a, b) {    return b[1]-a[1] ;});
strength_topics_list=strength_topics_list.slice(0,10)
weak_topics_list=weak_topics_list.slice(0,10)
highlight_strength_wekness(strength_topics_list,weak_topics_list)
}

function highlight_strength_wekness(strength_topics_list,weak_topics_list)
{
var listOfTopics_html="<table><tr><td style=\"border: 1px solid black;\"><b>HPU Strengths*</b><br>"
for (var i=0; i<strength_topics_list.length; i++)
{
if(i<5){
	document.getElementById("n"+strength_topics_list[i][0] ).classList.add("rotatetext1");
	document.getElementById("n"+strength_topics_list[i][0]).style.visibility = "visible"
}
listOfTopics_html=listOfTopics_html + topicsNode[strength_topics_list[i][0]].n + " (" + strength_topics_list[i][1].toFixed(2) +  ")<br>"
}

listOfTopics_html=listOfTopics_html + "</td><td style=\"border: 1px solid black;\"><b>HPU Weaknesses*</b><br>"
for (var i=0; i<weak_topics_list.length; i++)
{
if(i<5){
	document.getElementById("n"+weak_topics_list[i][0] ).classList.add("rotatetext2");
	document.getElementById("n"+weak_topics_list[i][0]).style.visibility = "visible"
}
listOfTopics_html=listOfTopics_html +  topicsNode[weak_topics_list[i][0]].n + " (" + weak_topics_list[i][1].toFixed(2) + ")<br>"
}
listOfTopics_html=listOfTopics_html + "</td></tr></table>* in per thousand"	;
document.getElementById("graphdiv").innerHTML=listOfTopics_html;
document.getElementById("graphdiv1").style.display="block"
Windowspreparation();

}



function showUniversityXX(d,pepoplecount) {


 var totalpeoplecount =433781

	for (i = 0; i < N; i++) {
//	 var u= isNaN(d[topicsNode[i]['n']] * 1000/pepoplecount) ? 0 : d[topicsNode[i]['n']] * 1000/pepoplecount
//	var w= topicsNode[i]['w'] * 1000/433781

var u=isNaN(d[topicsNode[i]['n']])  ? 0 : d[topicsNode[i]['n']]
var w=topicsNode[i]['w']
u= u * 1000/pepoplecount
w=w * 1000/totalpeoplecount
absval=(u-w ) * w


if(absval>0)
color='green'
else
color='red'

	icon = {
	  path: google.maps.SymbolPath.CIRCLE,
	  scale: Math.abs(absval)  ,
	  strokeColor: color,
	  fillColor: color,
	  fillOpacity: 0.5,
	  strokeWeight: 0
	}

	  if ( Math.abs(absval)>1) {
		marker[i].setMap(map);
		marker[i].setIcon(icon)
		marker[i].setVisible(true) //	label[i].setMap(map);
	  } else {
		marker[i].setVisible(false) //	label[i].setMap(null);
	  }
	}

}



function reset()
{zoomfunction();
//changebasemap(2);
	heatmap.setMap(null);


	for (i = 0; i < edgespoly.length; i++) {
	edgespoly[i].setMap(null);
	}
 	for (i = 0; i < marker.length; i++) {
	infowindow[i].close()
	marker[i].setMap(null);
	var x=document.getElementById("n"+i );
 	x.classList.remove("rotatetext1")
 	x.classList.remove("rotatetext2")

	}

document.getElementById("top10").innerHTML="<b> World Knolwledge Map </b>" + TopTenResearchTopics();
map.setZoom(5);

}



function is_small_for_zoom_level(zlevel, node)
{


			 weight=node["w"];
			 //  console.log(weight)
			if (zlevel==4 && weight< 700) return true
			if (zlevel==5 && weight< 500) return true
			if (zlevel==6 && weight< 300) return true
			if (zlevel==7 && weight< 100) return true
			if (zlevel==8 && weight< 0) return true

return false;

		}





function     zoomfunction() {
	zoomLevel = map.getZoom();
	//nodesizesetting=document.getElementById("changenodesizedropdown")
//	nodesizesetting = (nodesizesetting==null ? "degree" : nodesizesetting.value);

	if(zoomLevel < 2) {	map.setZoom(2);	return 0;}


if  (zoomLevel < 4){
	for(var i=0; i<N; i++)
		{
	//	document.getElementById("n"+i).style.visibility = "hidden"
		document.getElementById("s"+i).style.display="none"
		}
return 0;
}

if  (zoomLevel > 9){
	for(var i=0; i<N; i++)
		{
//		document.getElementById("n"+i).style.visibility = "visible"
		document.getElementById("s"+i).style.display="block"
		}
map.setZoom(9);
return 0;
}




	for(var i=0; i<N; i++)
		{
		var element=document.getElementById("s"+i)
		if ( map.getBounds().contains(marker[i].getPosition()) && parseInt( zoomdata[currentnetwork][zoomLevel][i])   )
	 //	element.style.visibility ="visible"
	 	element.style.display="block"
		else
 	// 	element.style.visibility = "hidden"
	 	element.style.display="none"
	}


}


var callcount=0
function    OLDzoomfunction() {

calculatingNodeVisibility()
return 0;
      }

function findOverLappedAndHide(v)
{

var v=v.sort(cmp);

var alreadydrawn=Array()
NN=v.length
j=0;
for (var i=0; i<NN; i++)
	{

	if (isoverlapped(alreadydrawn,v[i].box ))
	{var element=document.getElementById("s"+v[i].index);
	element.style.visibility = "hidden"
//	marker[v[i].index].setVisible(false)
	}
	else
	{
	alreadydrawn[j]=v[i].box;
	j=j+1;
	}
}

//console.log ("vertex in hidening:")
//console.log( NN-j)

}
function cmp(a, b) {
	  return b.font -a.font

}

function isoverlapped(array_alreadydrawn, box)
{
NNN=array_alreadydrawn.length
for(var i=0;i<NNN; i++)
if (intersectRect(box, array_alreadydrawn[i]))
return true;
return false;
}





function intersectRect(r1, r2) {
  return !(r2.left > r1.right ||
           r2.right < r1.left ||
           r2.top > r1.bottom ||
           r2.bottom < r1.top);
}


      function drawcluster(polygonpoints,fillColor) { //polygon,polygonpoints,fillColor
        for (i = 0; i < polygonpoints.length; i++) {
          polygon[i] = new google.maps.Polygon({
            paths: polygonpoints[i],
            strokeColor: fillColor[i],
            strokeOpacity: 1,
            strokeWeight: 0,
            map: map,
            fillColor: fillColor[i],
            fillOpacity: 0.5
          });
        }
      }

      function searchname(v) {
        var nfound = 0;

        if (v.length < 2)
          return 0;
        for (var i = 0; i < N; i++) {
          if (topicsNode[i]['n'].toLowerCase().includes(v.toLowerCase())) {
			marker[i].setMap(map);
            marker[i].setVisible(true);
			 marker[i].setIcon(null);
            found = marker[i].getPosition();
            nfound = nfound + 1;
          } else
            marker[i].setVisible(false);
        }
        if (nfound == 1) {   map.setCenter(found);      map.setZoom(7)  }

        if (nfound > 1) {       map.setCenter(found);         map.setZoom(5)      }
		 zoomfunction() ;
        return '1'
      }


function drawingnodes( ) {
	for (var i = 0; i < N; i++) {

		//var p=(topicsNode[i]['t'].length >2)? "<br>UofA People: " + topicsNode[i]['t'] :""
		var p="";//removed for docker version
		var info= "<b>"+ topicsNode[i]['n']+ "</b><br>People Count: " + topicsNode[i]['w'] + p ;
		infowindow[i] =  new google.maps.InfoWindow({content: info ,position: nodelatlan[i]	});

		marker[i] = new google.maps.Marker({position: nodelatlan[i],map: map,visible: false });
		label[i] = new Label({map: map,weight: topicsNode[i], nodenumber: i, data: topicsNode[i]['n'] });
		label[i].bindTo('position', marker[i], 'position');
		label[i].bindTo('text', marker[i], 'position');
//		label[i].style.visibility = "hidden";
		google.maps.event.addListener(marker[i], 'click', (function(marker, i) {return function() {	 infowindow[i].open(map,marker); showmyedges(i);} })(marker[i], i));
	}
}


function drawingedges(edgespath) {
	var strokeColor = 'purple'
var j=0
	for (var i = 0; i < E; i++) {
		//if(zoomdata[currentnetwork][6][edgesdata[i].i]=='1' && zoomdata[currentnetwork][6][edgesdata[i].j]=='1'){
		edgespoly[j] = new google.maps.Polyline({  path: edgespath[i],  geodesic: true,   zIndex:1000,  strokeColor: strokeColor,    strokeOpacity: 1,    strokeWeight: 1 });

	j=j+1;
//}

/*
(function(d, poly){
poly.addListener( 'mouseover', function(event) {    poly.setOptions({   strokeWeight:10,  strokeColor: 'red'  }); });
poly.addListener( 'mouseout', function(event) {     poly.setOptions({    strokeWeight: 0.5*d["f"], strokeColor:strokeColor  }); });
poly.addListener( 'click', function(event) {
			var edgeinfo =  new google.maps.InfoWindow({	content: "Loading.." , position: new google.maps.LatLng(event.latLng.lat(),event.latLng.lng())	});
			getEdgeDatafromServer( d["i"], d["j"], edgeinfo); });
})(edgesdata[i],edgespoly[i]);

*/


	}

}



function getEdgeDatafromServer(node1, node2, info)
{
 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {
	 info.setContent(this.responseText);
      info.open(map);

      return this.responseText;
    }
  };
  xhttp.open("GET", "/getedgeinfo/" + node1 + "/" +  node2 + "/" + currentnetwork, true);
  xhttp.send();

return "Loading";

}





function LabelX(opt_options) {

	var div;
	// Initialization
	this.setValues(opt_options);
	var SpanIndex=opt_options.nodenumber;
	size=getInitialFontSize(currentnetwork,opt_options.weight );
	div = this.div_ = document.createElement('div');
// 	div.style.cssText = 'position: absolute; left: -50%; top: -8px; ' +	'white-space: nowrap; border: 0px solid blue;  font-size: ' + size + '%; ' +	'padding: 2px; background-color: transparent';

 	div.style.cssText = 'position: absolute; left: -50%; top: -8px; white-space: nowrap; font-size: ' + size + '%; ' +	'padding: 2px;';


	div.id="n"+ SpanIndex
	div.innerHTML = opt_options.data;
//	div.appendChild(span);
//	div.style.cssText = 'position: absolute; display: none';

	google.maps.event.addDomListener(div, 'mouseover', function() {div.style.color = '#ff0000'; });
	google.maps.event.addDomListener(div, 'mouseout', function() {div.style.color = '#000000'; });

	google.maps.event.addDomListener(div, 'click', function() {
		infowindow[SpanIndex].open(map,marker[SpanIndex]);
		showmyedges(SpanIndex);	  });
}
































function changenodesize(basemapdata)
{


getReadyFontSizeforAll(currentnetwork,basemapdata)

for (i=0; i<N; i++)
{
		var element=document.getElementById("s"+i)
		element.style.fontSize = "" + fontsize[i] + '%';
}


zoomfunction();
return 0;
}

function getReadyFontSizeforAll(currentnetwork,basemapdata)
{
var nodeweight=0
for (i=0; i<N; i++)
{
if(currentnetwork==1) nodeweight=topicsNode[i]["w"];
else {
 nodeweight=basemapdata[topicsNode[i]["n"]];
}

	fontsize[i]=getInitialFontSize(currentnetwork,nodeweight)

}
}

function getInitialFontSize(currentnetwork,w)
{
var size = 100;
if (currentnetwork==1)
size=   parseInt(w /10)
else
size=   parseInt(w /6)

if (size < 100) size = 100
if (size > 300) size = 300;
return size;
}

/*
function getInitialFontSize1(network,w){
	var nodesizesettingvalue="degree";
//	nodesizesetting=document.getElementById("changenodesizedropdown")
//	nodesizesettingvalue = (nodesizesetting==null ? "degree" : nodesizesetting.value);
	var size = 80;
	switch(nodesizesettingvalue)	{
		case "degree":
			if (currentnetwork==1)
				size=   parseInt( w["w"]/10)
			else
				size= parseInt( w["w"] * 20)

			break;
		case "citation":
			size= parseInt( w["tc"])==0? 80 :  parseInt(18* Math.log( w["tc"]))//  w["tc"] / 200
			break;
		case "fund":
			size= parseInt( w["f"])==0? 80 : parseInt(15* Math.log( w["f"] )) // / 50
			break;
		}

	if (size < 80) size = 80
	if (size > 200) size = 200;
return size;
}

*/
function showmyedgesOLD(nodeindex) {
	for (i = 0; i < E; i++) {
	if (topicsNode[nodeindex].i==edgesdata[i].i || topicsNode[nodeindex].i==edgesdata[i].j )
	{
		edgespoly[i].setMap( edgespoly[i].getMap() ? null : map);
		edgespoly[i].setOptions({       strokeOpacity: 1          });
	}
}

      }

function clearscreen() {
	heatmap.setMap(null);
//	fundheatmaplayer.setMap(null);
	fundheatmapdata=[]
	delete heatmap


	for (i = 0; i < polygon.length; i++) {
	polygon[i].setMap(null);
	}
	polygon = []
	for (i = 0; i < edgespoly.length; i++) {
	edgespoly[i].setMap(null);
	}
	edgespoly = []
	for (i = 0; i < marker.length; i++) {
	label[i].setMap(null);
	marker[i].setMap(null);
	}
	marker = []
	label = []

}

function showfundheatmap(){








	cursorwait();
	toggleICON("showfundheatmapIMG")
	if(showfundheatmapflag==1)
	{
		for (i = 0; i < N; i++) { marker[i].setVisible(false)}
		showfundheatmapflag=0;
		cursordefault();
	return 0;
	}

	for (i = 0; i < N; i++) {
		if (topicsNode[i]['f'] > 0  )
		{ icon = {path: google.maps.SymbolPath.CIRCLE,  scale: parseInt(10* Math.log( topicsNode[i]['f']/1000)), strokeColor: 'green',       fillColor: 'green',          fillOpacity: 0.5,       strokeWeight: 0    }

		marker[i].setMap(map);
		marker[i].setIcon(icon)
		marker[i].setVisible(true) //	label[i].setMap(map);
		}
		else    marker[i].setVisible(false) //	label[i].setMap(null); }
	}

	showfundheatmapflag=1;
	cursordefault();
}

function citationheatmap() {
	toggleICON("citationheatmapIMG")
	heatmap.setMap(heatmap.getMap() ? null : map);
}

function toggleICON(img)
{
var toggleIMG=document.getElementById(img);
if(toggleIMG==null) return 0;
if (toggleIMG.style.opacity=="1") toggleIMG.removeAttribute("style")
else toggleIMG.style.opacity="1"
}

function hideClustering() {

	for (var i = 0; i < polygon.length; i++) {
		polygon[i].setMap(null);
	}
}


function toggleClustering() {
	toggleICON("toggleClusteringIMG")
	for (var i = 0; i < polygon.length; i++) {
		polygon[i].setMap(polygon[i].getMap() ? null : map);
	}
}


function networkIconReset(img)
{
	var networkicon = document.getElementsByClassName('networkicon');
	for (var i = 0; i < networkicon.length; i++) {networkicon[i].removeAttribute("style")}
		img.style.opacity = "1";
		img.style.filter  = 'alpha(opacity=100)'; // IE fallback
}


      function showedgesinCurrentLevel() {

	for (var i = 0; i < edgespoly.length; i++) {
		if(zoomdata[currentnetwork][zoomLevel][edgesdata[i].i]=='1' && zoomdata[currentnetwork][zoomLevel][edgesdata[i].j]=='1')
			edgespoly[i].setMap(map);
		else
			edgespoly[i].setMap(null);

	}

      }

      function changeRadius() {
        heatmap.set('radius', heatmap.get('radius') ? null : 20);
      }

      function toggleHeatmap() {
		toggleICON("toggleHeatmapIMG");
        heatmap.setMap(heatmap.getMap() ? null : map);
      }

      function edgeOpacity(v) {
        v = edgespoly[2].strokeOpacity + v;
        if (v < 0)  v = 0.02;
        if (v > 0.4) v = 0.4;
        for (i = 0; i < E; i++)
          edgespoly[i].setOptions({ strokeOpacity: v });
      }


    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6syHkkH53sjN9Dq9DOkadS635jnkNBgY&callback=initMap&libraries=visualization">


    </script>




<script>

document.onreadystatechange = function () {
  var state = document.readyState
  if (state == 'interactive') {
       document.getElementById('map').style.visibility="hidden";
  } else if (state == 'complete') {
      setTimeout(function(){

         document.getElementById('load').style.visibility="hidden";
         document.getElementById('map').style.visibility="visible";
      });
  }
}

function citationnormalizationtoggle(nor)
{
citationnormalization=nor;
}

function dropdownFunction(x) {
	document.getElementById("overlaytype").innerHTML=x;
    document.getElementById("CollegeDropdown").classList.toggle("show");
switch (x)
{case "Department Overlay":
	document.getElementById("userinputdiv").innerHTML="<input  class=\"dropbtn\" id='deptsearch'  type=text name=utext placeholder=\"main word. i.e computer\" ><br><input type=button value='Show' onclick='searchDepartment(this.value)'>";

break;
case "Document Overlay":
	document.getElementById("userinputdiv").innerHTML="<input  class=\"dropbtn\" id='docsearch'  type=text name=utext placeholder=\"url of document (html)\" ><br><input type=button value='Show' onclick='searchDocument(this.value)'>";
break;

case "Citation Overlay":

 document.getElementById("userinputdiv").innerHTML="<label><input type=checkbox name=normalized id=normalized "+(citationnormalization ? " checked ":"") +" onclick=citationnormalizationtoggle(this.checked)> Normalized </label><br><input  class=\"dropbtn\"  onkeyup=\"searchUniversity(this.value)\" type=text name=utext placeholder=\"Search University\" > ";


break;

default:
 document.getElementById("userinputdiv").innerHTML="<input  class=\"dropbtn\"  onkeyup=\"searchUniversity(this.value)\" type=text name=utext placeholder=\"Search University\" >";

}

}
function updatelegend()
{

HPU_Difference=parseFloat(document.getElementById("hpudiff").value/10);
HPU_Circle_amplifier = parseFloat(document.getElementById("hpucircle").value);
citation_intensity= parseFloat(document.getElementById("citationcircle").value);
var x=document.getElementById("citationascirclecircles");
if (x)
showCitationAsCircle=x.checked;

//if (document.getElementById("citationascirclecircle").checked)

document.getElementById('textm3').innerHTML="-"+ (40/ HPU_Circle_amplifier).toFixed(2);
document.getElementById('textm2').innerHTML= "-"+(25/ HPU_Circle_amplifier).toFixed(2);
document.getElementById('textm1').innerHTML= "-"+(15/ HPU_Circle_amplifier).toFixed(2);

document.getElementById('textp1').innerHTML="+"+ (15/ HPU_Circle_amplifier).toFixed(2);
document.getElementById('textp2').innerHTML="+"+ (25/ HPU_Circle_amplifier).toFixed(2);
document.getElementById('textp3').innerHTML= "+"+ (40/ HPU_Circle_amplifier).toFixed(2);

 document.getElementById('threshold').innerHTML= "Threshold:" + HPU_Difference + " (don't display if the threshold is less than this)";

document.getElementById('sutext1').innerHTML=    15* ucitation_factor /1000 + "K";
document.getElementById('sutext2').innerHTML=  25*  ucitation_factor /1000 + "K";
document.getElementById('sutext3').innerHTML=   40*   ucitation_factor /1000 + "K";



}
function showinfo(){

Windowspreparation2();
updatelegend();


var x=document.getElementById('infodiv1')
x.style.display="block";


}

function aggwindows()
{
Windowspreparation();
var a='<br>Select Aggregation</br> <select id="aggregatedProfile"><optgroup label="Carnegie Classifications"><option value= "non-LG">Non land-grant universities</option><option value= "LG" >land-grant universities</option><option value= "medical" >medical universities</option><option value= "non-medical" >Non medical universities</option><option value= "AAU" >AAU universities </option><option value= "non-AAU" >Non AAU universities </option><option value= "Public" >Public universities </option><option value= "Private" >Private universities</option><option value= "Public-LG" >Public and  land-grant universities </option><option value= "Public-NonLG" >Public and non land-grant universities</option><option value= "Private-AAU" >Private AAU universities</option><option value= "Public-AAU">Public AAU universities</option>  </optgroup> <optgroup label="Region Classifications"><option value= "All-US-universities" >US-universities</option><option value= "European-Universities" >European-Universities</option><option value= "Asian-Universities" >Asian-Universities</option><option value= "Canadian-Universities" >Canadian-Universities</option><option value= "AU-and-NZ" >AU-and-NZ Universities </option>  </optgroup></select>';
var b="</br>Visualization Type </br><select id='aggregatedvizType'><option value=HPU>HPU</option><option value=Citation>Citation</option><option value=nor-citation>Normalized Citation</option></select>";

document.getElementById("graphdiv").innerHTML=a+b+  "<br><input type=button onclick=showaggregatedProfile() value=\"Show\" > ";

var x=document.getElementById('graphdiv1')
x.style.display="block"


}



function showaggregatedProfile()
{
var aggregatedProfile=document.getElementById("aggregatedProfile").value;
var aggregatedvizType=document.getElementById("aggregatedvizType").value;


if(aggregatedvizType=="nor-citation")
 {
citationnormalization=1;
aggregatedvizType="Citation";
}
 else
citationnormalization=0;


 updatelegend();

 var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange=function() {
    if (this.readyState == 4 && this.status == 200) {
	  code=this.responseText;
	eval(code)     ;

	if(aggregatedvizType=="HPU")
		{showUniversity(HPU,peoplecount); var data=HPU; topTenforSelectedUniversity(data,name, peoplecount);}
	else { ccount=showCitationOverlay(citation,peoplecount,true); var data=citation; topTenforSelectedUniversity(data,name, ccount); }




    }
  };
  xhttp.open("GET", "/getuinfo/" + aggregatedProfile + "/" + aggregatedvizType , true);
  xhttp.send();

return "Loading";





}

window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {

    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-100691823-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>

</html>
